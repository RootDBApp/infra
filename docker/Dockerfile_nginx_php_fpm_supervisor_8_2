FROM bitnami/minideb:latest

LABEL \
	org.opencontainers.image.authors="PORQUET SÃ©bastien <sebastien.porquet@ijaz.fr>" \
	org.opencontainers.image.description="An open source self-hosted reporting application" \
	org.opencontainers.image.documentation="https://documentation.rootdb.fr/" \
	org.opencontainers.image.licenses="GNU AFFERO GENERAL PUBLIC LICENSE Version 3" \
	org.opencontainers.image.source="https://github.com/RootDBApp/infra/blob/main/docker/Dockerfile_nginx_php_fpm_8_2" \
	org.opencontainers.image.title="Base image for RootDB" \
	org.opencontainers.image.url="https://www.rootdb.fr/" \
	org.opencontainers.image.vendor="RootDB" \
	org.opencontainers.image.version="$VERSION"

RUN install_packages ca-certificates curl apt-transport-https software-properties-common wget  lsb-release \
    && curl -o /usr/local/bin/semver "https://raw.githubusercontent.com/fsaintjacques/semver-tool/master/src/semver" \
    && mkdir -p /etc/nginx/conf.d.tpl \
    && chmod +x /usr/local/bin/semver \
    && curl -sSL https://packages.sury.org/php/README.txt | bash -x \
    && install_packages \
    memcached \
    bzip2 \
    gawk \
    iputils-ping \
    iproute2 \
    jq \
    mariadb-client \
    nmap \
    nginx \
    procps \
    php8.2 \
    php8.2-curl \
    php8.2-dom \
    php8.2-fpm \
    php8.2-iconv \
    php8.2-mbstring \
    php8.2-memcached \
    php8.2-mysql \
    php8.2-pgsql \
    postgresql-client-common \
    supervisor \
    unzip


COPY nginx/nginx.conf /etc/nginx/nginx.conf
COPY nginx/conf.d.tpl /etc/nginx/conf.d.tpl

COPY supervisor/supervisord.conf /etc/
COPY supervisor/supervisor.d /etc/supervisor.d/

COPY php-fpm/8.2/fpm/pool.d/www.conf /etc/php/8.2/fpm/pool.d/www.conf
COPY php-fpm/8.2/fpm/php.ini /etc/php/8.2/fpm/php.ini
COPY php-fpm/8.2/fpm/php-fpm.conf /etc/php/8.2/fpm/php-fpm.conf
COPY php-fpm/8.2/cli/php.ini /etc/php/8.2/cli/php.ini
